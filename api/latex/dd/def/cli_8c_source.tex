\doxysection{cli.\+c}
\label{cli_8c_source}\index{cli.c@{cli.c}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#include\ "{}cli.h"{}}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}common/exitCodes.h"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}common/logging.h"{}}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}version.h"{}}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{comment}{//\ C\ preprocessor\ shenanigans\ to\ get\ stringizing\ and\ concatenation\ to\ work}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ for\ NO\_(x)\ macro,\ needed\ by\ DECLARE\_FLAG\ macro}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#define\ CONCAT(x,\ y)\ x\#\#y}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#define\ STRINGIZE\_IMPL(x)\ \#x}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#define\ STRINGIZE(x)\ STRINGIZE\_IMPL(x)}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#define\ NO\_(x)\ STRINGIZE(CONCAT(no\_,\ x))}}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#define\ DECLARE\_FLAG(name)\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \(\backslash\)}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\ \ \{\#name,\ no\_argument,\ \&ctx.tmpFlag,\ 1\},\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \(\backslash\)}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\ \ \ \ \ \ \{NO\_(name),\ no\_argument,\ \&ctx.tmpFlag,\ 0\}}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#define\ DECLARE\_ARG\_FOR\_MAP(x)\ \#x,\ \#x}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{comment}{//\ The\ struct\ 'option'\ is\ defined\ in\ getopt.h,\ and\ is\ expected\ by\ getopt\_long()}}
\DoxyCodeLine{00022\ \textcolor{comment}{//\ See\ docs/developer-\/guide/cli-\/options.md\ for\ details\ on\ how\ to\ add\ a\ new}}
\DoxyCodeLine{00023\ \textcolor{comment}{//\ option}}
\DoxyCodeLine{00024\ \textcolor{keyword}{static}\ \textcolor{keyword}{struct\ }option\ long\_options[]\ =\ \{\ \ \textcolor{comment}{//\ NOLINT}}
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{comment}{//\ These\ options\ set\ a\ flag\ (and\ they\ need\ to\ be\ at\ the\ top\ here\ for}}
\DoxyCodeLine{00026\ \ \ \ \ \textcolor{comment}{//\ indexing\ purposes).\ The\ DECLARE\_FLAG\ macro\ declares\ both\ <flag>\ and}}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{comment}{//\ <no\_flag>\ versions\ of\ the\ option.}}
\DoxyCodeLine{00028\ \ \ \ \ DECLARE\_FLAG(do\_main\_output),}
\DoxyCodeLine{00029\ \ \ \ \ DECLARE\_FLAG(do\_single\_outputs),}
\DoxyCodeLine{00030\ \ \ \ \ DECLARE\_FLAG(events),}
\DoxyCodeLine{00031\ \ \ \ \ DECLARE\_FLAG(print\_header),}
\DoxyCodeLine{00032\ \ \ \ \ DECLARE\_FLAG(dump\_config),}
\DoxyCodeLine{00033\ \ \ \ \ DECLARE\_FLAG(quiet),}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{comment}{//\ clang-\/format\ off}}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{comment}{//\ These\ options\ donâ€™t\ set\ a\ flag.\ We\ distinguish\ them\ by\ their\ indices}}
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{comment}{//\ name\ \ \ \ \ \ \ \ has\_arg\ \ \ \ \ \ \ \ \ \ \ flag\ \ val\ (val\ is\ the\ index)}}
\DoxyCodeLine{00038\ \ \ \ \ \{\textcolor{stringliteral}{"{}input\_file"{}},\ required\_argument,\ 0,\ \ \ \textcolor{charliteral}{'i'}\},}
\DoxyCodeLine{00039\ \ \ \ \ \{\textcolor{stringliteral}{"{}help"{}},\ \ \ \ \ \ \ no\_argument,\ \ \ \ \ \ \ 0,\ \ \ \textcolor{charliteral}{'h'}\},}
\DoxyCodeLine{00040\ \ \ \ \ \{\textcolor{stringliteral}{"{}version"{}},\ \ \ \ no\_argument,\ \ \ \ \ \ \ 0,\ \ \ \textcolor{charliteral}{'v'}\},}
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{comment}{//\ clang-\/format\ on}}
\DoxyCodeLine{00042\ \ \ \ \ \{0,\ 0,\ 0,\ 0\}\};}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \textcolor{comment}{//\ See\ cli.h}}
\DoxyCodeLine{00045\ \textcolor{keywordtype}{char}\ *argNameMap[]\ =\ \{}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{comment}{//\ Must\ follow\ same\ order\ as\ in\ long\_options\ above;\ only\ need\ flag\ opts\ here}}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{comment}{//\ Gives\ corresponding\ name\ in\ Context\ struct\ (that\ is,\ the\ argument\ to\ the}}
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{comment}{//\ DECLARE\_ARG\_FOR\_MAP\ macro\ needs\ to\ be\ the\ name\ of\ the\ corresponding\ field}}
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{comment}{//\ in\ Context)}}
\DoxyCodeLine{00050\ \ \ \ \ DECLARE\_ARG\_FOR\_MAP(doMainOutput),\ DECLARE\_ARG\_FOR\_MAP(doSingleOutputs),}
\DoxyCodeLine{00051\ \ \ \ \ DECLARE\_ARG\_FOR\_MAP(events),\ \ \ \ \ \ \ DECLARE\_ARG\_FOR\_MAP(printHeader),}
\DoxyCodeLine{00052\ \ \ \ \ DECLARE\_ARG\_FOR\_MAP(dumpConfig),\ \ \ DECLARE\_ARG\_FOR\_MAP(quiet)\};}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \textcolor{comment}{//\ Print\ the\ help\ message\ when\ requested}}
\DoxyCodeLine{00055\ \textcolor{keywordtype}{void}\ usage(\textcolor{keywordtype}{char}\ *progName)\ \{}
\DoxyCodeLine{00056\ \ \ \textcolor{comment}{//\ clang-\/format\ off}}
\DoxyCodeLine{00057\ \ \ printf(\textcolor{stringliteral}{"{}Usage:\ \%s\ [OPTIONS]"{}},\ progName);}
\DoxyCodeLine{00058\ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00059\ \ \ printf(\textcolor{stringliteral}{"{}Run\ SIPNET\ model\ for\ one\ site\ with\ configured\ options.\(\backslash\)n"{}});}
\DoxyCodeLine{00060\ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00061\ \ \ printf(\textcolor{stringliteral}{"{}Options:\ (defaults\ are\ shown\ in\ parens\ at\ end)\(\backslash\)n"{}});}
\DoxyCodeLine{00062\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/i,\ -\/-\/input\_file\ \ \ \ \ Name\ of\ input\ config\ file\ (sipnet.in)\(\backslash\)n"{}});}
\DoxyCodeLine{00063\ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00064\ \ \ printf(\textcolor{stringliteral}{"{}Flag\ options:\ (prepend\ flag\ with\ 'no\_'\ to\ force\ off,\ eg\ '-\/-\/no\_print\_header')\(\backslash\)n"{}});}
\DoxyCodeLine{00065\ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00066\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/-\/dump\_config\ \ \ \ Print\ final\ config\ to\ <input\_file>.config\ (0)\(\backslash\)n"{}});}
\DoxyCodeLine{00067\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/-\/print\_header\ \ \ Whether\ to\ print\ header\ row\ in\ output\ files\ (1)\(\backslash\)n"{}});}
\DoxyCodeLine{00068\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/-\/events\ \ \ \ \ \ \ \ \ Enable\ event\ handling\ (1)\(\backslash\)n"{}});}
\DoxyCodeLine{00069\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/-\/quiet\ \ \ \ \ \ \ \ \ \ Suppress\ info\ and\ warning\ message\ (0)\(\backslash\)n"{}});}
\DoxyCodeLine{00070\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/-\/[TBD]\ \ \ \(\backslash\)n"{}});}
\DoxyCodeLine{00071\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/-\/[TBD]\ \ \ \(\backslash\)n"{}});}
\DoxyCodeLine{00072\ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00073\ \ \ printf(\textcolor{stringliteral}{"{}Info\ options:\(\backslash\)n"{}});}
\DoxyCodeLine{00074\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/h,\ -\/-\/help\ \ \ \ \ \ \ \ \ \ \ Print\ this\ message\ and\ exit\(\backslash\)n"{}});}
\DoxyCodeLine{00075\ \ \ printf(\textcolor{stringliteral}{"{}\ \ -\/v,\ -\/-\/version\ \ \ \ \ \ \ \ Print\ version\ information\ and\ exit\(\backslash\)n"{}});}
\DoxyCodeLine{00076\ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00077\ \ \ printf(\textcolor{stringliteral}{"{}Configuration\ options\ are\ read\ from\ <input\_file>.\ Other\ options\ specified\ on\ the\ command\(\backslash\)n"{}});}
\DoxyCodeLine{00078\ \ \ printf(\textcolor{stringliteral}{"{}line\ override\ settings\ from\ that\ file.\(\backslash\)n"{}});}
\DoxyCodeLine{00079\ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00080\ \ \ \textcolor{comment}{//printf("{}\(\backslash\)n"{});}}
\DoxyCodeLine{00081\ \ \ \textcolor{comment}{//printf("{}\(\backslash\)n"{});}}
\DoxyCodeLine{00082\ \ \ \textcolor{comment}{//\ clang-\/format\ on}}
\DoxyCodeLine{00083\ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \textcolor{comment}{//\ Print\ the\ version\ when\ requested}}
\DoxyCodeLine{00086\ \textcolor{keywordtype}{void}\ version(\textcolor{keywordtype}{void})\ \{\ printf(\textcolor{stringliteral}{"{}SIPNET\ version\ \%s\(\backslash\)n"{}},\ VERSION\_STRING);\ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \textcolor{comment}{//\ Parses\ command-\/line\ options\ using\ getopt\_long}}
\DoxyCodeLine{00089\ \textcolor{keywordtype}{void}\ parseCommandLineArgs(\textcolor{keywordtype}{int}\ argc,\ \textcolor{keywordtype}{char}\ *argv[])\ \{}
\DoxyCodeLine{00090\ \ \ \textcolor{comment}{/*\ getopt\_long\ stores\ the\ option\ index\ here.\ */}}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordtype}{int}\ longIndex\ =\ 0;}
\DoxyCodeLine{00092\ \ \ \textcolor{keywordtype}{int}\ shortIndex;}
\DoxyCodeLine{00093\ \ \ \textcolor{comment}{//\ get\ command-\/line\ arguments:}}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{while}\ ((shortIndex\ =\ getopt\_long(argc,\ argv,\ \textcolor{stringliteral}{"{}hi:v"{}},\ long\_options,}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&longIndex))\ !=\ -\/1)\ \{}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keywordflow}{switch}\ (shortIndex)\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 0:}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ long\ form\ option,\ flag\ ==\ 0}}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ updateIntContext(argNameMap[longIndex],\ ctx.tmpFlag,\ CTX\_COMMAND\_LINE);}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'h'}:}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ usage(argv[0]);}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ exit(EXIT\_CODE\_SUCCESS);}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'i'}:}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (strlen(optarg)\ >=\ FILENAME\_MAXLEN)\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}ERROR:\ input\ filename\ \%s\ exceeds\ maximum\ length\ of\ \%d\(\backslash\)n"{}},}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ optarg,\ FILENAME\_MAXLEN);}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Either\ change\ the\ name\ or\ increase\ INPUT\_MAXNAME\ in\ "{}}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}frontend.c\(\backslash\)n"{}});}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ exit(1);}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ updateCharContext(\textcolor{stringliteral}{"{}inputFile"{}},\ optarg,\ CTX\_COMMAND\_LINE);}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'v'}:}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ version();}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ exit(EXIT\_CODE\_SUCCESS);}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ usage(argv[0]);}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ exit(EXIT\_CODE\_BAD\_CLI\_ARGUMENT);}
\DoxyCodeLine{00121\ \ \ \ \ \}}
\DoxyCodeLine{00122\ \ \ \}}
\DoxyCodeLine{00123\ \}}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \textcolor{comment}{//\ Safety\ check:\ make\ sure\ the\ elements\ of\ the\ cli\ argNameMap\ are\ actually}}
\DoxyCodeLine{00126\ \textcolor{comment}{//\ valid\ members\ -\/\ that\ is,\ that\ we\ can\ successfully\ find\ a\ metadata\ for\ each}}
\DoxyCodeLine{00127\ \textcolor{comment}{//\ one.\ This\ protects\ against\ changing\ a\ field\ name\ here\ and\ forgetting\ to}}
\DoxyCodeLine{00128\ \textcolor{comment}{//\ update\ that\ map.}}
\DoxyCodeLine{00129\ \textcolor{keywordtype}{void}\ checkCLINameMap(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00130\ \ \ \textcolor{keywordtype}{int}\ numFlags\ =\ 0;}
\DoxyCodeLine{00131\ \ \ \textcolor{keyword}{struct\ }context\_metadata\ *s;}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \textcolor{comment}{//\ Make\ sure\ everything\ in\ argNameMap\ maps\ to\ a\ valid\ metadata}}
\DoxyCodeLine{00134\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ ind\ =\ 0;\ ind\ <\ 2\ *\ NUM\_FLAG\_OPTIONS;\ ++ind)\ \{}
\DoxyCodeLine{00135\ \ \ \ \ s\ =\ getContextMetadata(argNameMap[ind]);}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keywordflow}{if}\ (s\ ==\ NULL)\ \{}
\DoxyCodeLine{00137\ \ \ \ \ \ \ logError(\textcolor{stringliteral}{"{}Internal\ error:\ mismatched\ argNameMap\ and\ Context\ contents;\ "{}}}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}missing\ Context\ metadata\(\backslash\)n"{}});}
\DoxyCodeLine{00139\ \ \ \ \ \ \ exit(EXIT\_CODE\_INTERNAL\_ERROR);}
\DoxyCodeLine{00140\ \ \ \ \ \}}
\DoxyCodeLine{00141\ \ \ \}}
\DoxyCodeLine{00142\ \ \ \textcolor{comment}{//\ Make\ sure\ the\ number\ of\ flag\ metadata\ structs\ equals\ NUM\_FLAG\_OPTIONS}}
\DoxyCodeLine{00143\ \ \ \textcolor{keywordflow}{for}\ (s\ =\ ctx.metaMap;\ s\ !=\ NULL;}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ s\ =\ (\textcolor{keyword}{struct\ }context\_metadata\ *)(s-\/>hh.next))\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keywordflow}{if}\ (s-\/>type\ ==\ CTX\_INT)\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \ \ ++numFlags;}
\DoxyCodeLine{00147\ \ \ \ \ \}}
\DoxyCodeLine{00148\ \ \ \}}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{if}\ (numFlags\ !=\ NUM\_FLAG\_OPTIONS)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ logError(\textcolor{stringliteral}{"{}Internal\ error:\ mismatched\ argNameMap\ and\ Context\ contents;\ "{}}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}missing\ argNameMap\ entry\(\backslash\)n"{}});}
\DoxyCodeLine{00152\ \ \ \ \ exit(EXIT\_CODE\_INTERNAL\_ERROR);}
\DoxyCodeLine{00153\ \ \ \}}
\DoxyCodeLine{00154\ \}}

\end{DoxyCode}
